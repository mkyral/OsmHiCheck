<script type="text/javascript">
    var msgError = "Nevyplneno vse";
    var msgErrorCoords = "Spatny format souradnic";
    var msgUserClickedOnRelation = "Bylo kliknuto na trasu nebo na prvek, poznámka bude obsahovat referenci na tyto prvky.";
    var CoordsDMS = false;

    prepareForm();

    function prepareForm() {
        var element = document.forms["addNote"];
        element['lat'].value = lngLatFromClick.lat;
        element['lng'].value = lngLatFromClick.lng;
        var div = document.getElementById('notice');
        if (dataFromClick) {
            div.innerHTML = msgUserClickedOnRelation;
        } else {
            div.innerHTML = "";
        }
    }

    function saveData() {
        if (validateForm()) {
            setError("");
            dataFromClick = false;
            $.post('php/saveNote.php', {
                lng: getFormValue('lng'),
                lat: getFormValue('lat'),
                name: getFormValue('name'),
                note: getFormValue('note')
            }, function(){
                if (map.hasLayer(temporaryMarker)) {
                    map.removeLayer(temporaryMarker);
                }
                userNotesNodesLayer.clearLayers();
                usernotesList = [];
                getData();
            });
        }
    }

    function validateForm() {
        var element = document.forms["addNote"];
        if(CoordsDMS) { //pro ulozeni do db potrebuji decimal format souradnice
            changeCoordinatesRepresentation();
        } else {
            if(!(validateCoords(element['lat'].value)) || !(validateCoords(element['lng'].value))){
                setError(msgErrorCoords);
                return false;
            }
        }
        if ((isEmpty(element["name"])) || (isEmpty(element["note"]))) {
            setError(msgError);
            return false;
        } else {
            return true;
        }
    }

    function validateCoords(coordValue) {
        var re = /[0-9]{1,2}[.][0-9]+/;
        var m;

        if ((m = re.exec(coordValue)) !== null) {
            return true;
        } else {
            return false;
        }
    }

    function setError(error) {
        var x = document.getElementById('error');
        x.innerHTML = error;
    }

    function isEmpty(input) {
        if (input.value == "" || input.value == null) {
            return true;
        } else {
            return false;
        }
    }

    function getFormValue(element) {
        return document.forms['addNote'][element].value;
    }

    function degreesDecimalToDMS(decimal){
        var DMS = [];
        decimal = parseFloat(decimal);
        DMS[0] = parseInt(decimal, 10);
        DMS[1] = parseInt(60*(decimal-DMS[0]), 10);
        DMS[2] = parseInt(3600*(decimal-DMS[0]-(DMS[1]/60)), 10);
        return DMS;
    }

    /**
     * @return {number}
     */
    function DMSToDecimal(DMS){
        return parseInt(DMS[0]) + (parseInt(DMS[1])/60) + (parseInt(DMS[2])/3600);
    }

    function simpleParseDMS(DMSString){
        var DMS = [];
        var reDeg = /[0-9]{1,2}(?=°)/;
        var reMin = /[0-9]{1,2}(?=')/;
        var reSec = /[0-9]{1,2}(?='')/;

        DMS[0] = reDeg.exec(DMSString);
        DMS[1] = reMin.exec(DMSString);
        DMS[2] = reSec.exec(DMSString);
        if(DMS[0]===null || DMS[1]===null || DMS[2]===null){
            return null;
        } else {
            DMS[0] = DMS[0][0];
            DMS[1] = DMS[1][0];
            DMS[2] = DMS[2][0];
            console.log(DMS);
            return DMS;
        }
    }

    function changeCoordinatesRepresentation(){
        if(CoordsDMS){
            CoordsDMS = false;
            var inputLat = simpleParseDMS(document.forms['addNote']['lat'].value);
            var inputLng = simpleParseDMS(document.forms['addNote']['lng'].value);
            document.forms['addNote']['lat'].value = DMSToDecimal(inputLat);
            document.forms['addNote']['lng'].value = DMSToDecimal(inputLng);
        } else {
            CoordsDMS = true;
            document.forms['addNote']['lat'].value = DMSToString(degreesDecimalToDMS(document.forms['addNote']['lat'].value));
            document.forms['addNote']['lng'].value = DMSToString(degreesDecimalToDMS(document.forms['addNote']['lng'].value));
        }
    }

    /**
     * @return {string}
     */
    function DMSToString(DMS){
        return DMS[0]+"° "+DMS[1]+"\' "+DMS[2]+"\'\'";
    }

</script>
<div id="error" class="red center"></div>
<form method="post" name="addNote" onsubmit="validateForm()" id="add-note">
    <label>Vytvoří se bod s poznámkou na souřadnicích:</label>
    <input type="text" name="lat" maxlength="50"/>
    <input type="text" name="lng" maxlength="50"/>
    <a href="#" onclick="changeCoordinatesRepresentation()">Změnit formát souřadnic (DMS <-> DEC)</a>
    <div id="notice" class="notice-yellow"></div>
    <a href="#" onclick="changeSidebarContent(CR_NODE1)">Zde poznámku nechci.</a><br/>
    <label>Zadejte jméno pro identifikaci:</label>
    <input type="text" name="name" placeholder="Jméno" maxlength="50"/>
    <textarea name="note" placeholder="Zde vložte svou poznámku" maxlength="1000"/>
    <label>Zde můžete nahrát fotku místa:</label>
    <input type="file" name="picture" placeholder=""/>
    <input type="button" value="Vložit" onclick="saveData()"/>
</form>